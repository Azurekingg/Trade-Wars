<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>The Rogue Trader Gauntlet</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #050b14;
            color: #e0f2fe;
            padding: 20px;
            text-align: center;
            background-image: 
                linear-gradient(rgba(5, 11, 20, 0.9), rgba(5, 11, 20, 0.9)),
                linear-gradient(90deg, rgba(56, 189, 248, 0.05) 1px, transparent 1px),
                linear-gradient(rgba(56, 189, 248, 0.05) 1px, transparent 1px);
            background-size: 100% 100%, 40px 40px, 40px 40px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 { 
            font-family: 'Orbitron', sans-serif;
            color: #0ea5e9; 
            font-size: 3em; 
            margin-bottom: 10px; 
            text-transform: uppercase; 
            letter-spacing: 3px; 
            text-shadow: 0 0 15px rgba(14, 165, 233, 0.6);
        }
        .subtitle { color: #94a3b8; font-size: 1.2em; margin-bottom: 10px; }
        .chapter-title { 
            font-family: 'Orbitron', sans-serif;
            color: #0ea5e9; 
            font-size: 1.5em; 
            font-weight: bold; 
            margin-bottom: 40px; 
            text-transform: uppercase; 
            letter-spacing: 2px; 
            text-shadow: 0 0 10px rgba(14, 165, 233, 0.5); 
        }

        .status-bar {
            background: #1e293b;
            padding: 20px;
            border-radius: 12px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin-bottom: 40px;
            border: 1px solid #334155;
        }

        .heart { color: #ef4444; font-size: 1.5em; }
        .token { color: #fbbf24; font-size: 1.5em; margin: 0 5px; }

        .boss-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .boss-card {
            background: #1e293b;
            border: 2px solid #334155;
            border-radius: 12px;
            padding: 20px;
            position: relative;
            overflow: hidden;
            transition: transform 0.2s;
            cursor: pointer;
            text-decoration: none;
            color: inherit;
            display: block;
            min-height: 200px; /* Ensure uniform height */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        /* Background Image Layer */
        .boss-card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            opacity: 0.65; /* 65% Opacity as requested */
            z-index: 0;
            transition: transform 0.3s;
        }

        /* Content Layer */
        .boss-card-content {
            position: relative;
            z-index: 1;
            background: rgba(15, 23, 42, 0.8); /* Dark overlay for text readability */
            padding: 15px;
            border-radius: 8px;
            width: 100%;
            box-sizing: border-box;
            backdrop-filter: blur(2px);
        }

        .boss-card:hover:not(.defeated):not(.locked) {
            transform: translateY(-5px);
            border-color: #ef4444;
        }
        
        .boss-card:hover::before {
            transform: scale(1.05);
        }

        .boss-card.defeated {
            opacity: 0.5;
            border-color: #10b981;
            cursor: default;
        }
        
        .boss-card.locked {
            opacity: 0.3;
            cursor: not-allowed;
            filter: grayscale(100%);
        }

        .boss-title { font-size: 1.5em; font-weight: bold; margin-bottom: 5px; color: #38bdf8; text-shadow: 0 0 10px rgba(56, 189, 248, 0.8), 0 0 20px rgba(14, 165, 233, 0.5); }
        .boss-name { font-size: 1.1em; color: #e2e8f0; margin-bottom: 15px; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .boss-ability { font-size: 0.9em; color: #cbd5e1; font-style: italic; }

        /* Tech Button for Black Market */
        .btn-black-market {
            position: relative;
            background: rgba(124, 58, 237, 0.1);
            color: #7c3aed;
            border: 2px solid #7c3aed;
            padding: 15px 30px;
            font-size: 1.2em;
            border-radius: 0;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            margin-top: 20px;
            clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%);
            transition: all 0.2s;
            text-transform: uppercase;
            font-weight: bold;
            text-shadow: 0 0 5px rgba(124, 58, 237, 0.5);
        }
        
        .btn-black-market:hover {
            background: rgba(124, 58, 237, 0.2);
            box-shadow: 0 0 20px rgba(124, 58, 237, 0.4);
            transform: translateY(-2px);
        }

        .defeated-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #10b981;
            color: black;
            padding: 5px 10px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.8em;
            z-index: 2;
        }

        /* Token Modal */
        #token-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        #token-modal.show { display: flex; }
        .token-modal-content {
            background: #1e293b;
            padding: 40px;
            border-radius: 12px;
            border: 2px solid #fbbf24;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .token-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            margin: 5px 0;
            background: rgba(30, 41, 59, 0.5);
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Black Market Blitz</h1>
        <div class="subtitle">Defeat the Bosses to reclaim your glory</div>
        <div class="chapter-title">Chapter 1: The Blitz</div>
        <div style="color: #94a3b8; font-size: 1em; margin-top: 10px; margin-bottom: 20px; max-width: 800px; line-height: 1.6; margin-left: auto; margin-right: auto; text-align: center;">
            In the shadows of Wall Street, a new breed of trader emerged. They didn't play by the rules‚Äîthey made their own. Six bosses control the underground markets. Defeat them all to claim your place at the top.
        </div>

        <div class="status-bar">
            <div>
                <span style="display:block; font-size:0.9em; color:#94a3b8;">LIVES</span>
                {% for i in range(run_state.hearts) %}
                <span class="heart">‚ù§</span>
                {% endfor %}
            </div>
            <div>
                <span style="display:block; font-size:0.9em; color:#94a3b8;">TOKENS</span>
                <span id="token-display" style="cursor: pointer; text-decoration: underline;" onclick="showTokens()">
                    {% if run_state.tokens %}
                        ü™ô{% if run_state.tokens|length > 1 %}x{{ run_state.tokens|length }}{% endif %}
                    {% else %}
                        <span style="color:#64748b;">None</span>
                    {% endif %}
                </span>
            </div>
            <div>
                <a href="/" style="color: #94a3b8; text-decoration: none;">Exit Run</a>
            </div>
        </div>

        <div class="boss-grid">
            {% for boss in bosses %}
            {% set is_defeated = boss.id in run_state.defeated_bosses %}
            {% set is_final = boss.id == 'final_boss' %}
            {% set is_locked = is_final and run_state.defeated_bosses|length < 6 %}
            
            {% if is_defeated %}
            <div class="boss-card defeated">
                <style>.boss-card:nth-child({{ loop.index }}) { background-image: none; } .boss-card:nth-child({{ loop.index }})::before { background-image: url("{{ url_for('static', filename='images/' + boss.image) }}"); }</style>
                <div class="defeated-badge">DEFEATED</div>
                <div class="boss-card-content">
                    <div class="boss-title">{{ boss.title }}</div>
                    <div class="boss-name">{{ boss.name }}</div>
                </div>
            </div>
            {% elif is_locked %}
            <div class="boss-card locked">
                <style>.boss-card:nth-child({{ loop.index }}) { background-image: none; } .boss-card:nth-child({{ loop.index }})::before { background-image: url("{{ url_for('static', filename='images/' + boss.image) }}"); }</style>
                <div class="boss-card-content">
                    <div class="boss-title">???</div>
                    <div class="boss-name">Final Boss</div>
                    <div style="margin-top:10px;">Defeat all 6 bosses to unlock</div>
                </div>
            </div>
            {% else %}
            <a href="/rogue/lobby/{{ boss.id }}" class="boss-card">
                <style>.boss-card:nth-child({{ loop.index }}) { background-image: none; } .boss-card:nth-child({{ loop.index }})::before { background-image: url("{{ url_for('static', filename='images/' + boss.image) }}"); }</style>
                <div class="boss-card-content">
                    <div class="boss-title">{{ boss.title }}</div>
                    <div class="boss-name">{{ boss.name }}</div>
                    <div class="boss-ability">Ability: {{ boss.ability_desc }}</div>
                    <div style="margin-top:10px; font-size:0.8em; color:#ef4444;">Reward: {{ boss.token_name }}</div>
                </div>
            </a>
            {% endif %}
            {% endfor %}
        </div>
        
        <div style="margin-top: 50px; border-top: 2px solid #334155; padding-top: 20px;">
            <div class="chapter-title" style="color: #c084fc; text-shadow: 0 0 10px rgba(192, 132, 252, 0.5);">Chapter 2: The Syndicate Wars</div>
            <div class="subtitle">{% if ch2_unlocked %}Tournaments Unlocked{% else %}Defeat The Bear-on of Wall Street to unlock{% endif %}</div>
            <div style="color: #94a3b8; font-size: 1em; margin-top: 10px; margin-bottom: 20px; max-width: 800px; line-height: 1.6; margin-left: auto; margin-right: auto; text-align: center;">
                With the bosses defeated, a new threat emerges. The Syndicates‚Äîorganized crime families of finance. They control entire market sectors through manipulation. Four powerful organizations await your challenge.
            </div>
            
            {% if ch2_unlocked %}
            <div style="display:flex; justify-content:center; gap:20px; margin-bottom: 20px;">
                <a href="/syndicate/recruit" class="btn-black-market" style="background: rgba(59, 130, 246, 0.1); border-color: #3b82f6; color: #3b82f6; margin-top:0;">Mercenary Guild</a>
            </div>
            
            <div class="boss-grid">
                {% for syn in syndicates %}
                {% set has_emblem = syn.token_id in syndicate_data.emblems %}
                
                {% if has_emblem %}
                <div class="boss-card defeated">
                    <style>.boss-card::before { opacity: 0.65; }</style>
                    <div class="defeated-badge">CONQUERED</div>
                    <div class="boss-card-content">
                        <div class="boss-title" style="color:#c084fc;">{{ syn.name }}</div>
                        <div class="boss-name">{{ syn.boss_name }}</div>
                    </div>
                </div>
                {% else %}
                <a href="/syndicate/lobby/{{ syn.id }}" class="boss-card">
                    <style>
                        .boss-card:nth-child({{ loop.index + 7 }})::before { 
                            background-image: url("{{ url_for('static', filename='images/' + syn.image) }}"); 
                            opacity: 0.65; 
                        }
                    </style>
                    <div class="boss-card-content">
                        <div class="boss-title" style="color:#c084fc; text-shadow: 0 0 10px rgba(192, 132, 252, 0.8);">{{ syn.name }}</div>
                        <div class="boss-name">Leader: {{ syn.boss_name }}</div>
                        <div class="boss-ability">{{ syn.theme }}</div>
                        <div style="margin-top:5px; font-size:0.9em; color:#94a3b8;">{{ syn.desc }}</div>
                        <div style="margin-top:10px; font-size:0.8em; color:#c084fc;">Reward: {{ syn.token_name }}</div>
                    </div>
                </a>
                {% endif %}
                {% endfor %}
            </div>
            {% else %}
            <div style="background: #1e293b; padding: 40px; border-radius: 12px; opacity: 0.5; border: 2px dashed #475569;">
                <div style="font-size: 1.5em; color: #94a3b8;">LOCKED</div>
                <div>Defeat The Bear-on of Wall Street to access Syndicate Wars</div>
                <div style="margin-top: 20px;">
                    <div style="color: #c084fc; font-weight: bold; margin-bottom: 10px;">[TEST MODE: Access Tournaments]</div>
                    <a href="/syndicate/recruit" style="color: #c084fc; text-decoration: underline; display: block; margin: 5px 0;">[Mercenary Guild]</a>
                    {% for syn in syndicates %}
                    <a href="/syndicate/lobby/{{ syn.id }}" style="color: #60a5fa; text-decoration: underline; display: block; margin: 5px 0;">[TEST: {{ syn.name }}]</a>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Chapter 3: The Global Blackout -->
        <div style="margin-top: 50px; border-top: 2px solid #334155; padding-top: 20px;">
            <div class="chapter-title" style="color: #fbbf24; text-shadow: 0 0 10px rgba(251, 191, 36, 0.5);">Chapter 3: The Global Blackout</div>
            <div class="subtitle">{% if ch3_unlocked %}Systemic Risk Challenges Unlocked{% else %}Complete all Chapter 2 Tournaments to unlock{% endif %}</div>
            <div style="color: #94a3b8; font-size: 1em; margin-top: 10px; margin-bottom: 20px; max-width: 800px; line-height: 1.6; margin-left: auto; margin-right: auto; text-align: center;">
                The final layer of corruption reveals itself. Global institutions that control systemic risk itself. These are the puppet masters of the entire financial system. Four legendary institutions stand between you and true dominance.
            </div>
            
            {% if ch3_unlocked %}
            <div class="boss-grid">
                {% for boss in ch3_bosses %}
                {% set is_defeated = boss.id in run_state.defeated_bosses %}
                
                {% if is_defeated %}
                <div class="boss-card defeated">
                    <style>
                        .boss-card:nth-child({{ loop.index + 11 }})::before { 
                            background-image: url("{{ url_for('static', filename='images/' + boss.image) }}"); 
                            opacity: 0.65; 
                        }
                    </style>
                    <div class="defeated-badge">DEFEATED</div>
                    <div class="boss-card-content">
                        <div class="boss-title" style="color:#fbbf24;">{{ boss.title }}</div>
                        <div class="boss-name">{{ boss.name }}</div>
                    </div>
                </div>
                {% else %}
                <a href="/rogue/lobby/{{ boss.id }}" class="boss-card">
                    <style>
                        .boss-card:nth-child({{ loop.index + 11 }})::before { 
                            background-image: url("{{ url_for('static', filename='images/' + boss.image) }}"); 
                            opacity: 0.65; 
                        }
                    </style>
                    <div class="boss-card-content">
                        <div class="boss-title" style="color:#fbbf24; text-shadow: 0 0 10px rgba(251, 191, 36, 0.8);">{{ boss.title }}</div>
                        <div class="boss-name">{{ boss.name }}</div>
                        <div class="boss-ability">Ability: {{ boss.ability_desc }}</div>
                        <div style="margin-top:10px; font-size:0.8em; color:#fbbf24;">Reward: {{ boss.token_name }}</div>
                    </div>
                </a>
                {% endif %}
                {% endfor %}
            </div>
            {% else %}
            <div style="background: #1e293b; padding: 40px; border-radius: 12px; opacity: 0.5; border: 2px dashed #475569;">
                <div style="font-size: 1.5em; color: #94a3b8;">LOCKED</div>
                <div>Complete all Chapter 2 Tournaments to access The Global Blackout</div>
                <div style="margin-top: 20px;">
                    {% for boss in ch3_bosses %}
                    <a href="/rogue/lobby/{{ boss.id }}" style="color: #fbbf24; text-decoration: underline; display: block; margin: 5px 0;">[TEST: {{ boss.name }}]</a>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>

        <a href="/black_market" class="btn-black-market">Enter Black Market Store</a>
    </div>

    <!-- Audio Logic -->
    <div id="mute-btn-container" style="position: fixed; bottom: 20px; right: 20px; z-index: 1000;">
        <button id="mute-btn" style="background: rgba(30, 41, 59, 0.8); border: 1px solid #475569; border-radius: 50%; width: 50px; height: 50px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px;">üîä</button>
    </div>

    <audio id="bg-music" loop>
        <source src="{{ url_for('static', filename='sounds/game-music-loop-7-145285.mp3') }}" type="audio/mpeg">
    </audio>
    <audio id="hover-sound">
        <source src="{{ url_for('static', filename='sounds/ui-interface-sound-6-299043.mp3') }}" type="audio/mpeg">
    </audio>
    <audio id="select-sound">
        <source src="{{ url_for('static', filename='sounds/ui-interface-sound-18-299047.mp3') }}" type="audio/mpeg">
    </audio>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var audio = document.getElementById('bg-music');
            var muteBtn = document.getElementById('mute-btn');
            var hoverSound = document.getElementById('hover-sound');
            var selectSound = document.getElementById('select-sound');
            
            // Check local storage for settings
            var isMuted = localStorage.getItem('bg_music_muted') === 'true';
            var savedTime = parseFloat(localStorage.getItem('bg_music_time') || 0);
            var savedBgmVol = localStorage.getItem('bgm_volume');
            var savedSfxVol = localStorage.getItem('sfx_volume');
            var savedTrack = localStorage.getItem('bgm_track');

            // Apply Saved Settings
            if(savedTrack) {
                var currentSrc = audio.querySelector('source').src;
                if(!currentSrc.includes(savedTrack)) {
                     audio.querySelector('source').src = "{{ url_for('static', filename='') }}" + savedTrack;
                     audio.load();
                }
            }

            audio.currentTime = savedTime;
            audio.muted = isMuted;
            if(savedBgmVol !== null) audio.volume = parseFloat(savedBgmVol);
            muteBtn.innerHTML = isMuted ? 'üîá' : 'üîä';

            if(savedSfxVol !== null) {
                hoverSound.volume = parseFloat(savedSfxVol);
                selectSound.volume = parseFloat(savedSfxVol);
            }

            // Try to play BGM
            var playPromise = audio.play();
            if (playPromise !== undefined) {
                playPromise.catch(error => console.log('Autoplay prevented'));
            }

            // Mute toggle
            muteBtn.addEventListener('click', function() {
                audio.muted = !audio.muted;
                localStorage.setItem('bg_music_muted', audio.muted);
                muteBtn.innerHTML = audio.muted ? 'üîá' : 'üîä';
                if (audio.paused && !audio.muted) audio.play();
            });

            // Save time periodically
            setInterval(function() {
                if(!audio.paused) localStorage.setItem('bg_music_time', audio.currentTime);
            }, 1000);
            
            // Save time on unload
            window.addEventListener('beforeunload', function() {
                localStorage.setItem('bg_music_time', audio.currentTime);
            });

            // Button Hover Sounds
            const buttons = document.querySelectorAll('button, a, .boss-card');
            buttons.forEach(btn => {
                btn.addEventListener('mouseenter', () => {
                    hoverSound.currentTime = 0;
                    var savedSfxVol = localStorage.getItem('sfx_volume');
                    if (savedSfxVol !== null) hoverSound.volume = parseFloat(savedSfxVol);
                    hoverSound.play().catch(e => {});
                });
            });

            // Selection Sounds
            const bosses = document.querySelectorAll('.boss-card:not(.locked):not(.defeated)');
            bosses.forEach(boss => {
                boss.addEventListener('click', function() {
                    selectSound.currentTime = 0;
                    selectSound.play().catch(e => {});
                });
            });
        });

        function showTokens() {
            const modal = document.getElementById('token-modal');
            modal.classList.add('show');
        }

        function closeTokenModal() {
            const modal = document.getElementById('token-modal');
            modal.classList.remove('show');
        }
    </script>

    <!-- Token Modal -->
    <div id="token-modal" onclick="closeTokenModal()">
        <div class="token-modal-content" onclick="event.stopPropagation()">
            <h2 style="color: #fbbf24; margin-top: 0;">Your Collection</h2>
            <div>
                <h3 style="color: #c084fc;">Chapter 1 Tokens:</h3>
                {% set token_counts = {} %}
                {% for t in run_state.tokens %}
                    {% if t in token_counts %}
                        {% set _ = token_counts.update({t: token_counts[t] + 1}) %}
                    {% else %}
                        {% set _ = token_counts.update({t: 1}) %}
                    {% endif %}
                {% endfor %}
                {% for token in run_state.tokens %}
                <div class="token-item">
                    <span>ü™ô {{ token }}</span>
                    <span>x1</span>
                </div>
                {% endfor %}
            </div>
            <div style="margin-top: 20px;">
                <h3 style="color: #c084fc;">Chapter 2 Emblems:</h3>
                {% set emblem_counts = {} %}
                {% for e in syndicate_data.emblems %}
                    {% if e in emblem_counts %}
                        {% set _ = emblem_counts.update({e: emblem_counts[e] + 1}) %}
                    {% else %}
                        {% set _ = emblem_counts.update({e: 1}) %}
                    {% endif %}
                {% endfor %}
                {% for emblem in syndicate_data.emblems %}
                <div class="token-item">
                    <span>‚≠ê {{ emblem }}</span>
                    <span>x1</span>
                </div>
                {% endfor %}
            </div>
            <button onclick="closeTokenModal()" style="margin-top: 20px; padding: 10px 20px; background: #334155; color: white; border: none; border-radius: 4px; cursor: pointer;">Close</button>
        </div>
    </div>
</body>
</html>




