<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Multiplayer Lobby - Stock Wars</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e0e0e0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }
        
        .container {
            width: 95%;
            max-width: 1100px;
            background: rgba(30, 41, 59, 0.85);
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .lobby-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #334155;
            padding-bottom: 20px;
        }

        h1 { margin: 0; color: #60a5fa; font-size: 2em; }
        .room-code { font-size: 3em; font-weight: 900; color: #fbbf24; letter-spacing: 5px; }

        .players-panel {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 30px;
            background: #0f172a;
            padding: 20px;
            border-radius: 12px;
        }

        .player-card {
            text-align: center;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #334155;
            position: relative;
        }

        .player-card.active { border-color: #34d399; background: rgba(52, 211, 153, 0.1); }
        .player-card.empty { border-style: dashed; opacity: 0.6; }
        
        .p-name { font-size: 1.5em; font-weight: bold; margin-bottom: 10px; display: block; }
        .p-status { font-size: 0.9em; text-transform: uppercase; color: #94a3b8; }
        .ready-badge { 
            background: #10b981; color: white; padding: 5px 10px; 
            border-radius: 20px; font-size: 0.8em; display: none; 
            margin-top: 10px;
        }

        .settings-panel {
            margin-bottom: 30px;
            text-align: center;
        }

        .wager-input {
            background: #1e293b;
            border: 1px solid #475569;
            color: white;
            padding: 10px;
            font-size: 1.2em;
            width: 150px;
            text-align: center;
            border-radius: 8px;
        }

        /* Ability Grid (Compact) */
        .ability-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 30px;
            max-height: 400px;
            overflow-y: auto;
        }

        .ability-card-item {
            background: #1e293b;
            border: 1px solid #334155;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            position: relative;
            font-size: 0.9em;
        }
        
        .ability-card-item:hover { border-color: #60a5fa; }
        .ability-card-item input { position: absolute; top: 10px; right: 10px; }

        /* Tech Button */
        .btn-ready {
            position: relative;
            width: 100%;
            padding: 20px;
            font-size: 2em;
            font-weight: 900;
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
            border: 2px solid #3b82f6;
            border-radius: 0;
            cursor: pointer;
            text-transform: uppercase;
            clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%);
            transition: all 0.2s;
            text-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }
        
        .btn-ready:disabled {
            background: rgba(71, 85, 105, 0.1);
            border-color: #475569;
            color: #475569;
            cursor: not-allowed;
            text-shadow: none;
        }
        
        .btn-ready:hover:not(:disabled) {
            background: rgba(59, 130, 246, 0.2);
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.4);
            transform: translateY(-2px);
        }

        .waiting-msg { color: #facc15; font-style: italic; margin-top: 10px; display: block;}
    </style>
</head>
<body>
    <div class="container">
        <div class="lobby-header">
            <div>
                <h1>Lobby</h1>
                <div style="margin-top: 10px;">
                    <span style="color: #94a3b8; font-size: 0.9em;">Mode: </span>
                    <span style="color: {% if game_mode == 'one_v_one' %}#10b981{% elif game_mode == 'free_for_all' %}#3b82f6{% else %}#fbbf24{% endif %}; font-weight: bold; text-transform: uppercase;">
                        {% if game_mode == 'one_v_one' %}1v1{% elif game_mode == 'free_for_all' %}Free-for-All{% else %}Coop (2v2){% endif %}
                    </span>
                </div>
                <a href="/multiplayer" style="color: #94a3b8; text-decoration: none;">‚Üê Leave Room</a>
            </div>
            <div class="room-code">{{ room_code }}</div>
        </div>

        <div class="players-panel" style="{% if game_mode == 'one_v_one' %}grid-template-columns: repeat(2, 1fr);{% else %}grid-template-columns: repeat(2, 1fr);{% endif %}">
            <div class="player-card active" id="player-1-card">
                <span class="p-name" id="player-1-name">HOST</span>
                <span class="p-status" id="player-1-status">In Lobby</span>
                <div class="ready-badge" id="player-1-ready">READY</div>
            </div>
            <div class="player-card {{ 'active' if guest_joined else 'empty' }}" id="player-2-card">
                <span class="p-name" id="player-2-name">{{ 'GUEST' if guest_joined else 'Waiting...' }}</span>
                <span class="p-status" id="player-2-status">{{ 'In Lobby' if guest_joined else 'Share code to join' }}</span>
                <div class="ready-badge" id="player-2-ready">READY</div>
            </div>
            {% if game_mode == 'one_v_one' %}
            {# 1v1 mode - only show 2 players #}
            {% elif game_mode == 'free_for_all' %}
            <div class="player-card empty" id="player-3-card">
                <span class="p-name" id="player-3-name">Waiting...</span>
                <span class="p-status" id="player-3-status">Slot Available</span>
                <div class="ready-badge" id="player-3-ready">READY</div>
            </div>
            <div class="player-card empty" id="player-4-card">
                <span class="p-name" id="player-4-name">Waiting...</span>
                <span class="p-status" id="player-4-status">Slot Available</span>
                <div class="ready-badge" id="player-4-ready">READY</div>
            </div>
            {% elif game_mode == 'coop' %}
            <div class="player-card empty" id="player-3-card">
                <span class="p-name" id="player-3-name">Team 1 - Waiting...</span>
                <span class="p-status" id="player-3-status">Slot Available</span>
                <div class="ready-badge" id="player-3-ready">READY</div>
            </div>
            <div class="player-card empty" id="player-4-card">
                <span class="p-name" id="player-4-name">Team 2 - Waiting...</span>
                <span class="p-status" id="player-4-status">Slot Available</span>
                <div class="ready-badge" id="player-4-ready">READY</div>
            </div>
            {% endif %}
        </div>

        <form id="lobby-form">
            <div class="settings-panel">
                {% if is_host %}
                <div style="margin-bottom: 20px;">
                    <label style="font-size: 1.2em; margin-right: 10px;">Game Mode:</label>
                    <select id="game-mode-select" class="wager-input" style="width: auto; text-align: left; cursor: pointer;">
                        <option value="one_v_one" {% if game_mode == 'one_v_one' %}selected{% endif %}>1v1</option>
                        {% if is_admin %}
                        <option value="free_for_all" {% if game_mode == 'free_for_all' %}selected{% endif %}>Free-for-All (Up to 4 players)</option>
                        <option value="coop" {% if game_mode == 'coop' %}selected{% endif %}>Coop (2v2)</option>
                        {% else %}
                        <option value="free_for_all" disabled style="color: #64748b;">Free-for-All - Coming Soon!</option>
                        <option value="coop" disabled style="color: #64748b;">Coop (2v2) - Coming Soon!</option>
                        {% endif %}
                    </select>
                </div>
                {% else %}
                <div style="margin-bottom: 20px;">
                    <label style="font-size: 1.2em; margin-right: 10px;">Game Mode:</label>
                    <span id="game-mode-display" style="font-size: 1.2em; color: #fbbf24; font-weight: bold;">
                        {% if game_mode == 'one_v_one' %}1v1{% elif game_mode == 'free_for_all' %}Free-for-All{% else %}Coop (2v2){% endif %}
                    </span>
                </div>
                {% endif %}
                {% if is_host %}
                <div style="margin-bottom: 20px;">
                    <label style="font-size: 1.2em; margin-right: 10px;">Number of Rounds:</label>
                    <input type="number" id="num-rounds" class="wager-input" value="1" min="1" max="10" step="1">
                </div>
                {% else %}
                <div style="margin-bottom: 20px;">
                    <label style="font-size: 1.2em; margin-right: 10px;">Number of Rounds:</label>
                    <span id="rounds-display" style="font-size: 1.2em; color: #fbbf24; font-weight: bold;">1</span>
                </div>
                {% endif %}
                <div style="margin-bottom: 20px;">
                    <label style="font-size: 1.2em; margin-right: 10px;">Wager Amount ($):</label>
                    {% if is_host %}
                        <input type="number" id="wager" class="wager-input" value="1000" min="0" step="100">
                    {% else %}
                        <span id="wager-display" style="font-size: 1.5em; font-weight: bold; color: #fbbf24;">1000</span>
                        <input type="hidden" id="wager" value="1000">
                    {% endif %}
                </div>
                <div>
                    <label style="font-size: 1.2em; margin-right: 10px;">Market Sector:</label>
                    {% if is_host %}
                        <select id="market-select" class="wager-input" style="width: auto; text-align: left; cursor: pointer;">
                            {% for m in markets %}
                            <option value="{{ m.id }}">{{ m.name }} ({{ m.volatility_label }} Vol)</option>
                            {% endfor %}
                        </select>
                    {% else %}
                        <span id="market-display" style="font-size: 1.2em; color: #fbbf24; font-weight: bold;">Waiting for Host...</span>
                    {% endif %}
                </div>
                {% if is_host %}
                <div style="margin-top: 15px;">
                    <label style="font-size: 1.2em; margin-right: 10px;">Abilities:</label>
                    <label style="cursor: pointer; display: inline-flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="abilities-toggle" {% if abilities_enabled %}checked{% endif %} style="width: 20px; height: 20px; cursor: pointer;">
                        <span id="abilities-status" style="font-size: 1.2em; color: {% if abilities_enabled %}#10b981{% else %}#ef4444{% endif %};">
                            {% if abilities_enabled %}Active{% else %}Off{% endif %}
                        </span>
                    </label>
                </div>
                {% else %}
                <div style="margin-top: 15px;">
                    <label style="font-size: 1.2em; margin-right: 10px;">Abilities:</label>
                    <span id="abilities-display" style="font-size: 1.2em; color: #fbbf24; font-weight: bold;">Waiting for Host...</span>
                </div>
                {% endif %}
            </div>

            <h3>Select Loadout (Max 3)</h3>
            <div class="ability-grid">
                {% for ability in abilities %}
                <label class="ability-card-item">
                    <div style="font-weight:bold; margin-bottom:5px;">{{ ability.name }}</div>
                    <div style="font-size:0.8em; color:#94a3b8;">{{ ability.rarity }} - ${{ ability.cost }}</div>
                    <div style="font-size:0.8em; margin-top:5px;">{{ ability.description }}</div>
                    <input type="checkbox" name="abilities" value="{{ ability.id }}">
                </label>
                {% endfor %}
            </div>

            <button type="button" class="btn-ready" id="ready-btn" onclick="submitReady()">CONFIRM & READY</button>
            {% if is_admin and is_host %}
            <button type="button" class="btn-ready" id="solo-test-btn" onclick="startSoloTest()" style="background: rgba(139, 92, 246, 0.2); border-color: #8b5cf6; color: #8b5cf6; margin-top: 10px;">
                üß™ START SOLO TEST (Admin)
            </button>
            {% endif %}
            <span id="status-msg" class="waiting-msg"></span>
        </form>
    </div>

    <!-- Audio Persistence -->
    <div id="mute-btn-container" style="position: fixed; bottom: 20px; right: 20px; z-index: 1000;">
        <button id="mute-btn" style="background: rgba(30, 41, 59, 0.8); border: 1px solid #475569; border-radius: 50%; width: 50px; height: 50px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px;">üîä</button>
    </div>

    <audio id="bg-music" loop>
        <source src="{{ url_for('static', filename='sounds/game-music-loop-7-145285.mp3') }}" type="audio/mpeg">
    </audio>
    <audio id="hover-sound">
        <source src="{{ url_for('static', filename='sounds/ui-interface-sound-6-299043.mp3') }}" type="audio/mpeg">
    </audio>
    <audio id="select-sound">
        <source src="{{ url_for('static', filename='sounds/ui-interface-sound-18-299047.mp3') }}" type="audio/mpeg">
    </audio>

    <script>
        const roomCode = "{{ room_code }}";
        const isHost = {{ 'true' if is_host else 'false' }};
        let myReady = false;

        // Handle abilities toggle for host
        {% if is_host %}
        const abilitiesToggle = document.getElementById('abilities-toggle');
        const abilitiesStatus = document.getElementById('abilities-status');
        if (abilitiesToggle) {
            abilitiesToggle.addEventListener('change', function() {
                const enabled = this.checked;
                abilitiesStatus.textContent = enabled ? 'Active' : 'Off';
                abilitiesStatus.style.color = enabled ? '#10b981' : '#ef4444';
                
                // Update server
                fetch('/multiplayer/toggle_abilities', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        room_code: roomCode,
                        abilities_enabled: enabled
                    })
                });
            });
        }
        {% endif %}

        function submitReady() {
            const selected = Array.from(document.querySelectorAll('input[name="abilities"]:checked')).map(cb => cb.value);
            const wager = document.getElementById('wager').value || document.getElementById('wager-display').innerText;
            
            let marketId = null;
            const marketSelect = document.getElementById('market-select');
            if (marketSelect) marketId = marketSelect.value;
            
            let numRounds = 1;
            {% if is_host %}
            const numRoundsInput = document.getElementById('num-rounds');
            if (numRoundsInput) numRounds = parseInt(numRoundsInput.value) || 1;
            const abilitiesEnabled = document.getElementById('abilities-toggle') ? document.getElementById('abilities-toggle').checked : true;
            {% else %}
            const abilitiesEnabled = true; // Guest doesn't control this
            {% endif %}

            if (selected.length > 3) {
                alert("Select max 3 abilities!");
                return;
            }

            fetch('/multiplayer/ready', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    room_code: roomCode,
                    abilities: selected,
                    wager: parseInt(wager),
                    market_id: marketId,
                    abilities_enabled: abilitiesEnabled,
                    num_rounds: numRounds
                })
            })
            .then(res => res.json())
            .then(data => {
                if(data.success) {
                    myReady = true;
                    document.getElementById('ready-btn').disabled = true;
                    document.getElementById('ready-btn').innerText = "WAITING FOR OPPONENT...";
                    document.getElementById('status-msg').innerText = "You are ready.";
                } else {
                    alert(data.message);
                }
            });
        }

        {% if is_admin and is_host %}
        function startSoloTest() {
            const selected = Array.from(document.querySelectorAll('input[name="abilities"]:checked')).map(cb => cb.value);
            const wager = document.getElementById('wager').value || 0;
            
            let marketId = 'blue_chip';
            const marketSelect = document.getElementById('market-select');
            if (marketSelect) marketId = marketSelect.value;
            
            let numRounds = 1;
            const numRoundsInput = document.getElementById('num-rounds');
            if (numRoundsInput) numRounds = parseInt(numRoundsInput.value) || 1;
            
            const abilitiesEnabled = document.getElementById('abilities-toggle') ? document.getElementById('abilities-toggle').checked : true;

            if (selected.length > 3) {
                alert("Select max 3 abilities!");
                return;
            }

            if (!confirm('Start solo test with AI opponent?')) return;

            fetch('/multiplayer/admin_solo_test', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    room_code: roomCode,
                    abilities: selected,
                    wager: parseInt(wager),
                    market_id: marketId,
                    abilities_enabled: abilitiesEnabled,
                    num_rounds: numRounds
                })
            })
            .then(res => res.json())
            .then(data => {
                if(data.success) {
                    window.location.href = '/battle';
                } else {
                    alert(data.message || 'Failed to start solo test');
                }
            });
        }
        {% endif %}

        // Polling loop
        setInterval(() => {
            fetch(`/multiplayer/state/${roomCode}`)
            .then(res => res.json())
            .then(state => {
                // Update players list
                if (state.players && Array.isArray(state.players)) {
                    state.players.forEach((player, index) => {
                        const playerNum = index + 1;
                        const playerCard = document.getElementById(`player-${playerNum}-card`);
                        const playerName = document.getElementById(`player-${playerNum}-name`);
                        const playerStatus = document.getElementById(`player-${playerNum}-status`);
                        const playerReady = document.getElementById(`player-${playerNum}-ready`);
                        
                        if (playerCard && playerName && playerStatus) {
                            if (player.username) {
                                playerCard.classList.remove('empty');
                                playerCard.classList.add('active');
                                playerName.textContent = player.username.toUpperCase();
                                playerStatus.textContent = player.ready ? 'Ready' : 'In Lobby';
                                if (playerReady) {
                                    playerReady.style.display = player.ready ? 'block' : 'none';
                                }
                            } else {
                                playerCard.classList.add('empty');
                                playerCard.classList.remove('active');
                                playerName.textContent = 'Waiting...';
                                playerStatus.textContent = 'Slot Available';
                                if (playerReady) playerReady.style.display = 'none';
                            }
                        }
                    });
                }
                
                // Legacy: Update Guest status (for backwards compatibility)
                if (state.guest_joined) {
                    const guestCard = document.getElementById('guest-card');
                    if (guestCard) {
                        guestCard.classList.remove('empty');
                        guestCard.classList.add('active');
                        const guestName = document.getElementById('guest-name');
                        const guestStatus = document.getElementById('guest-status');
                        if (guestName) guestName.innerText = "GUEST";
                        if (guestStatus) guestStatus.innerText = "Connected";
                    }
                }

                // Update Wager (for Guest)
                if (!isHost && state.wager) {
                    document.getElementById('wager-display').innerText = state.wager;
                    document.getElementById('wager').value = state.wager;
                }

                // Update Market (for Guest)
                if (!isHost && state.market_name) {
                    const mDisplay = document.getElementById('market-display');
                    if(mDisplay) mDisplay.innerText = state.market_name;
                }
                
                // Update game mode display for guest
                {% if not is_host %}
                if(state.game_mode) {
                    const modeDisplay = document.getElementById('game-mode-display');
                    if (modeDisplay) {
                        let modeText = '1v1';
                        if (state.game_mode === 'free_for_all') modeText = 'Free-for-All';
                        else if (state.game_mode === 'coop') modeText = 'Coop (2v2)';
                        modeDisplay.textContent = modeText;
                    }
                }
                {% endif %}
                
                // Update abilities display for guest
                {% if not is_host %}
                if(state.abilities_enabled !== undefined) {
                    const abilitiesDisplay = document.getElementById('abilities-display');
                    if (abilitiesDisplay) {
                        abilitiesDisplay.textContent = state.abilities_enabled ? 'Active' : 'Off';
                        abilitiesDisplay.style.color = state.abilities_enabled ? '#10b981' : '#ef4444';
                    }
                }
                {% endif %}

                // Update Ready Badges
                if (state.host_ready) document.getElementById('host-ready').style.display = 'inline-block';
                if (state.guest_ready) document.getElementById('guest-ready').style.display = 'inline-block';

                // Check for Game Start
                if (state.game_started) {
                    window.location.href = "/battle";
                }
            });
        }, 1000);

        // Audio Logic
        document.addEventListener('DOMContentLoaded', function() {
            var audio = document.getElementById('bg-music');
            var muteBtn = document.getElementById('mute-btn');
            var hoverSound = document.getElementById('hover-sound');
            var selectSound = document.getElementById('select-sound');
            
            var isMuted = localStorage.getItem('bg_music_muted') === 'true';
            var savedTime = parseFloat(localStorage.getItem('bg_music_time') || 0);
            var savedBgmVol = localStorage.getItem('bgm_volume');
            var savedSfxVol = localStorage.getItem('sfx_volume');
            var savedTrack = localStorage.getItem('bgm_track');

            if(savedTrack) {
                var currentSrc = audio.querySelector('source').src;
                if(!currentSrc.includes(savedTrack)) {
                     audio.querySelector('source').src = "{{ url_for('static', filename='') }}" + savedTrack;
                     audio.load();
                }
            }

            audio.currentTime = savedTime;
            audio.muted = isMuted;
            if(savedBgmVol !== null) audio.volume = parseFloat(savedBgmVol);
            muteBtn.innerHTML = isMuted ? 'üîá' : 'üîä';

            if(savedSfxVol !== null) {
                hoverSound.volume = parseFloat(savedSfxVol);
                selectSound.volume = parseFloat(savedSfxVol);
            }

            var playPromise = audio.play();
            if (playPromise !== undefined) playPromise.catch(e => console.log('Autoplay prevented'));

            muteBtn.addEventListener('click', function() {
                audio.muted = !audio.muted;
                localStorage.setItem('bg_music_muted', audio.muted);
                muteBtn.innerHTML = audio.muted ? 'üîá' : 'üîä';
                if (audio.paused && !audio.muted) audio.play();
            });

            setInterval(function() {
                if(!audio.paused) localStorage.setItem('bg_music_time', audio.currentTime);
            }, 1000);
            
            window.addEventListener('beforeunload', function() {
                localStorage.setItem('bg_music_time', audio.currentTime);
            });

            // Button Hover Sounds
            const buttons = document.querySelectorAll('.btn-ready, a, .ability-card-item');
            buttons.forEach(btn => {
                btn.addEventListener('mouseenter', () => {
                    hoverSound.currentTime = 0;
                    hoverSound.play().catch(e => {});
                });
            });

            // Selection Sounds
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(box => {
                box.addEventListener('change', function() {
                    if(this.checked) {
                        selectSound.currentTime = 0;
                        selectSound.play().catch(e => {});
                    }
                });
            });
        });
    </script>
</body>
</html>